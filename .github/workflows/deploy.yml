name: ðŸš€ Deploy Backend to cPanel

on:
  push:
    branches:
      - master
      - main

jobs:
  deploy:
    name: ðŸŽ‰ Deploy to cPanel
    runs-on: ubuntu-latest

    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build Application
        run: npm run build

      - name: ðŸ—„ï¸ Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: ðŸ—ƒï¸ Run Database Migrations (Optional)
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        continue-on-error: true

      - name: ðŸ“‚ Create production .env file
        run: |
          cat > .env << EOF
          # Server Configuration
          NODE_ENV=production
          PORT=8000
          CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}

          # Database
          DATABASE_URL=${{ secrets.DATABASE_URL }}

          # JWT Secrets
          JWT_ACCESS_SECRET=${{ secrets.JWT_ACCESS_SECRET }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
          JWT_ACCESS_EXPIRY=15m
          JWT_REFRESH_EXPIRY=7d

          # Email Configuration
          SMTP_HOST=${{ secrets.SMTP_HOST }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_USER=${{ secrets.SMTP_USER }}
          SMTP_PASS=${{ secrets.SMTP_PASS }}

          # Email - Resend (Fallback)
          RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
          RESEND_FROM_EMAIL=${{ secrets.RESEND_FROM_EMAIL }}

          # Application
          APP_NAME=${{ secrets.APP_NAME }}
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}

          # Cloudinary Configuration
          CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}

          # Payment Gateway - eSewa
          ESEWA_MERCHANT_ID=${{ secrets.ESEWA_MERCHANT_ID }}
          ESEWA_SECRET_KEY=${{ secrets.ESEWA_SECRET_KEY }}
          ESEWA_ENVIRONMENT=${{ secrets.ESEWA_ENVIRONMENT }}
          ESEWA_PRODUCT_CODE=${{ secrets.ESEWA_PRODUCT_CODE }}
          EOF

      - name: ðŸ”§ Create PM2 Ecosystem File
        run: |
          cat > ecosystem.config.cjs << EOF
          module.exports = {
            apps: [{
              name: 'vaastu-backend',
              script: 'src/server.js',
              instances: 1,
              autorestart: true,
              watch: false,
              max_memory_restart: '1G',
              env: {
                NODE_ENV: 'production',
                PORT: 8000,
                UV_THREADPOOL_SIZE: 4,
                NODE_OPTIONS: '--max-old-space-size=256'
              },
              error_log: './logs/err.log',
              out_log: './logs/out.log',
              log_log: './logs/combined.log',
              time: true
            }]
          };
          EOF

      - name: ðŸ“‚ Create logs directory
        run: mkdir -p logs

      - name: ðŸ“¤ Deploy to cPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.3
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: api.vastu.reemangroup.com/
          exclude: |
            **/.git**
            **/.github**
            **/node_modules/**
            **/.env.example**
            **/LMS_API.postman_*.json**
            **/README.md**
            **/.gitignore**
            **/prisma/migrations/**
